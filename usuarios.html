<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="lib/sweetalert2/dist/sweetalert2.min.css" />
    <!-- Favicon -->
    <link rel="icon" href="img/logo.png" type="image/png">
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
    <!-- Icons -->
    <link rel="stylesheet" href="lib/argon-dashboard-master/assets/vendor/nucleo/css/nucleo.css" type="text/css">
    <link rel="stylesheet" href="lib/argon-dashboard-master/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" type="text/css">
    <!-- Page plugins -->
    <!-- Argon CSS -->

    <link rel="stylesheet" href="lib/argon-dashboard-master/assets/css/argon.css?v=1.2.0" type="text/css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css" type="text/css">
    <link href=" lib/bootstrap-fileinput-master/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <style type="text/css">

        /* Button used to open the contact form - fixed at the bottom of the page */
        .open-button {
          background-color: #555;
          color: white;
          padding: 16px 20px;
          border: none;
          opacity: 0.8;
          position: fixed;
          width: 500px;
        }
        /* The popup form - hidden by default */
        .form-popup {
          display: none;
          position: fixed;
          bottom: 0;
          margin:0 auto !important;
          right:400px;
         
          z-index: 9;
        }
        /* Add styles to the form container */
        .form-container {
          max-width: 500px;
          padding: 10px;
          border: 5px solid #f1f1f1;
          border-radius: 10px;
          background-color: white;   
        }
        /* Full-width input fields */
        .form-container input[type=text], .form-container input[type=password] {
          width: 80%;
          padding: 15px;
          margin: 5px 0 10px 0;
          border: none;
          background: #f1f1f1;
        }
        /* When the inputs get focus, do something */
        .form-container input[type=text]:focus, .form-container input[type=password]:focus {
          background-color: #ddd;
          outline: none;
        }
        /* Set a style for the submit/login button */
        .form-container .btn {
          background-color: #4CAF50;
          color: white;
          border: none;
          cursor: pointer;
          width: 100%;
          margin-bottom:5px;
          opacity: 0.8;
        }
        /* Add a red background color to the cancel button */
        .form-container .cancel {
          background-color: red;
        }
        /* Add some hover effects to buttons */
        .form-container .btn:hover, .open-button:hover {
          opacity: 1;
        }
        </style>
</head>
<body style="background-image:none !important">
    <div class="main-content" id="panel">
        <div id="header"></div>
        <div class="header pb-6">
            <div class="container-fluid">
                <div class="header-body">
            </br>
            <h1 for="guia">Gestion de Estudiantes </h1>
            </br>
                    <div style ='text-align:left'>
                        <h4>Agregar Estudiante</h4>
                        <i class="fas fa-plus-circle" onclick='openForm()' style ='font-size:40px; margin-left:30px' ></i>
                    </div>
                </div>
            </div>
        </div>
        </br>
        <div class="container-fluid mt--6">
            <table id="table_id" name ="table_id" style="width:100%; padding: 30px; text-align: center" class="table table-striped table-bordered table-sm ">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>RUT</th>
                        <th>Telefono</th>
                        <th>Correo</th>
                        <th>Seccion</th>
                        <th>Editar</th>
                        <th>Ver</th>
                        <th>Eliminar</th>     
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
    <div class="form-popup" id="myForm">
        <form id="form" class="form-container">
            <label for="Pregunta"><b>Nombres</b></label>
            <input type="text" placeholder="Nombre" style ="width:70%" name="nombre"  id="nombre" required>
            </br>
                <div id="sec"></div>
            </br>
                <label for="b"><b>Apellidos </b></label>
                <input type="text" class="textarea" style ="width:65%"  placeholder="Respuesta" name="apellido" id="apellido"  required>
            </br>
                <label for="b"><b>Rut </b></label>
                <input type="text" class="textarea" style ="width:65%"  placeholder="Respuesta" name="rut" id="rut"  required>
            </br>
                <label for="b"><b>Telefono </b></label>
                <input type="text" class="textarea" style ="width:65%"  placeholder="Respuesta" name="telefono" id="telefono"  required>
            </br>
                <label for="b"><b>Correo </b></label>
                <input type="text" class="textarea" style ="width:65%"  placeholder="Respuesta" name="correo" id="correo"  required>
            </br>
                <button type="button" id ="subir" class="btn">Subir</button>
                <button type="button" class="btn cancel" onclick="closeForm()">Cancelar</button>
        </form>
    </div>
</body>
<script src="lib/argon-dashboard-master/assets/vendor/jquery/dist/jquery.min.js"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/js-cookie/js.cookie.js"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/jquery.scrollbar/jquery.scrollbar.min.js"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/jquery-scroll-lock/dist/jquery-scrollLock.min.js"></script>
  <!-- Optional JS -->
  <script src="lib/argon-dashboard-master/assets/vendor/chart.js/dist/Chart.min.js"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/chart.js/dist/Chart.extension.js"></script>
  <!-- Argon JS -->
  <script src="lib/argon-dashboard-master/assets/js/argon.js?v=1.2.0"></script>
  <script src="lib/argon-dashboard-master/assets/vendor/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="lib/font-awesome/js/fontawesome.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="//cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="lib/datatables/js/jquery.dataTables.js"></script>
<script type="text/javascript" src="lib/datatables/js/dataTables.bootstrap.min.js"></script>
<script src="lib/bootstrap-fileinput-master/js/fileinput.min.js" type="text/javascript"></script>
<script src="lib/bootstrap-fileinput-master/js/locales/es.js" type="text/javascript"></script>	
<script>
    var url='https://api.estudiantevirtual.cl';
//var url="http://api.dev.estudiantevirtual.cl";
if(localStorage["perfil"]==null){
        window.location.href="index.html";
}else{
    perfil=localStorage["perfil"];
    var AuxPerfil=JSON.parse(perfil);
}
$(function () {
    if(AuxPerfil.type==2){
        $("#header").load("head4.html");
        $(".btn-get").hide();
        setTimeout(() => {
            console.log(AuxPerfil);
            $("#perfil").html(AuxPerfil.nombre);
        }, 1000);
    }
});
   // console.log(AuxPerfil);
    var pruebas;
     $.ajax({
        url: url+"/Login/listEstudiantes/"+AuxPerfil.id_institucion,
        type: 'Get',
        success: function(repos){
            //console.log(JSON.parse(auxtext));
            var table = $('#table_id').DataTable();
            table.destroy(); 
            $('#table_id').DataTable({
                        dom: 'Bfrtip',
                        "language": {
                        "url": "lib/datatables/language/Spanish.json"
                    },
                    "data":repos,
                    "columns": [
                        {
                            "data": "nombre"
                        }
                        ,
                        {
                            "data": "apellido"
                        }
                        ,
                        {
                            "data": "rut"
                        }
                        ,
                        {
                            "data": "telefono"
                        },
                        {
                            "data": "correo"
                        },
                        
                        {
                            "data": "seccion"
                        }
                        ,
                            {"defaultContent": "<i id='editar'  onclick='openForm()' name='editar' class='fas fa-pencil-alt' style ='text-align:center;font-size:40px' ></i>"}
                        ,
                            {"defaultContent": "<i id='ver' name='ver' class='fas fa-eye' style ='text-align:center;font-size:40px' ></i>"}
                        ,
                            {"defaultContent": "<i id='borrar' class='fas fa-trash-alt fa-3x' name='borrar' style ='text-align:center; font-size:40px'></i>"}
                        ],
                });
        }
     });
     $(document).on('click', '#ver', function (e) {
        var valores = "";
        $(this).parents("tr").find("td").each(function () {
            valores += $(this).html() + "~";
    });
    var aux=valores.split("~");
    for(var i =0;i<pruebas.length;i++){
        if(aux[0]==pruebas[i].nombre){
            localStorage["id_prueba"]=pruebas[i].id;
            localStorage["pru"]=aux[0];
            localStorage["nivel"]=aux[1];
            window.location.href="opciones.html";
        }
    }
});
var num=-1;
     $(document).on('click', '#editar', function (e) {
        var valores = "";
        $(this).parents("tr").find("td").each(function () {
            valores += $(this).html() + "~";
    });
    var aux=valores.split("~");
    num=-1;
    for (var i=0; i<pruebas.length;i++){
        if(pruebas[i].nombre==aux[0] && num ==-1 && pruebas[i].status==1){
            num=i;
        }
    }
    var auxini = pruebas[num].ini.split("T");
    var ini=auxini[0].split("-");
    //console.log(ini);
    var auxfin =pruebas[num].fin.split("T");
    var fin=auxfin[0].split("-");
    document.getElementById("nombre").value=pruebas[num].nombre;
    document.getElementById("apellido").value=pruebas[num].apellido;
    document.getElementById("correo").value=pruebas[num].correo;
    document.getElementById("telefono").value=pruebas[num].telefono;
    document.getElementById("seccion").value=pruebas[num].seccion;
});
$(document).on('click', '#borrar', function (e) {
    Swal.fire({
        title: 'Enviando datos',
        html: 'Por favor espere.',
        timer: 10000,
        timerProgressBar: true,
        onBeforeOpen: () => {
            Swal.showLoading()
            timerInterval = setInterval(() => { 100})
        },
        onClose: () => {
            clearInterval(timerInterval)
        }
    });
    var valores = "";
        $(this).parents("tr").find("td").each(function () {
            valores += $(this).html() + "~";
    });
    var aux=valores.split("~");
    //console.log(aux);
    //console.log(pruebas);
    for(var i =0;i<pruebas.length;i++){
        if(aux[0]==pruebas[i].nombre){
            console.log(pruebas[i].id);
            eliminado(pruebas[i].id);
            break;
        }
    }
})
function openForm() {
    $.ajax({
        url:url+"/asignatura/listSecciones",
        type:"POST",
        data: JSON.stringify({"id_institucion": AuxPerfil.id_institucion}),
        headers: {
            "Content-Type":"application/json",
        },
        success: function(respo){
            response=respo;
            var text='<select id="seccion" style="width:90%; border-radius:5px;">';
            for (var i =0;i< response.length;i++){
                text=text+'<option value="'+response[i].id+'">'+response[i].nombre+'</option>';
            }
            $("#sec").html(text);
            document.getElementById("myForm").style.display = "block";
            text=text+'</select>';
            document.getElementById("sec").innerHTML=text;
        }
    })
}
function closeForm() {
    document.getElementById("prueba").value="";
    document.getElementById("myForm").style.display = "none";
}
$("#subir").on("click", function(){
    if(valida()==true){
        json=[];
        json["nombre"]=$("#nombre").val();
        json["apellido"]=$("#apellido").val();
        json["correo"]=$("#correo").val();
        json["telefono"]=$("#telefono").val();
        json["rut"]=$("#rut").val();
        json["seccion"]=$("#seccion").val();
        json["id_institucion"]=AuxPerfil.id_institucion;
       $.ajax({
            url:url+"/Login/saveEstudiantes",
            type:"POST",
            data: json,
            headers: {
                "Content-Type":"application/json",
            },
            success: function(respo){
                console.log(respo);
            }
       })
    }
})
function valida(){
    if(document.getElementById("nombre").value==""){
        alert("Debe llenar el nombre");
        return false; 
    }if(document.getElementById("apellido").value==""){
        alert("Debe llenar el apellido");
        return false; 
    }if(document.getElementById("correo").value==""){
        alert("Debe llenar el correo");
        return false; 
    }if(document.getElementById("telefono").value==""){
        alert("Debe llenar el telefono");
        return false; 
    }if(document.getElementById("rut").value==""){
        alert("Debe llenar el rut");
        return false; 
    }
    return true;
}
function eliminado(id){
    $.ajax({
       url: 'https://apiciencoas.azurewebsites.net/api/prueba/eliminarp',
        type: 'POST',
        data:   '{"id":"'+id+'","asignatura":"'+AuxPerfil.asignatura+'"}',
        headers: {
            "Content-Type": ["application/json", "text/plain"]
        },
        success: function(repos){
            Swal.fire({
                title: "Listo!",
                text: "Prueba Eliminada Correctamente",
                type: 'success',
            }).then(function (result){
                window.location.reload();
            })
        }
    });
}


function letras(string){//Solo numeros
    var out = '';
    var filtro = '1234567890';//Caracteres validos
    //Recorrer el texto y verificar si el caracter se encuentra en la lista de validos 
    for (var i=0; i<string.length; i++)
       if (filtro.indexOf(string.charAt(i) ) != -1 && i < 2) 
             //Se añaden a la salida los caracteres validos
	     out += string.charAt(i);
    //Retornar valor filtrado
    return out;
} 
function letras2(string){//Solo numeros
    var out = '';
    var filtro = '1234567890';//Caracteres validos
    //Recorrer el texto y verificar si el caracter se encuentra en la lista de validos 
    for (var i=0; i<string.length; i++)
       if (filtro.indexOf(string.charAt(i) ) != -1 && i < 3) 
             //Se añaden a la salida los caracteres validos
	     out += string.charAt(i);
    //Retornar valor filtrado
    return out;
} 

</script>